hookpunch.history=function(){hookpunch.history={};hookpunch.history.init=function(){!hookpunch.initialised&&hookpunch.options.history&&(hookpunch.history={undoFlag:!1,busyRevertingValue:!1})};ko.extenders.trackHistory=function(a,c){a.propertyName=c.propertyName;a.revertValue=a.originalState[a.propertyName];a.version=0;a.subscribe(function(){if(!hookpunch.history.busyRevertingValue){var b=a.parent._hookpunch.id;hookpunch.history[b].changes||(hookpunch.history[b].changes=[]);hookpunch.history.undoFlag&&
(hookpunch.history[b].changes=[],a.version=0,hookpunch.history.undoFlag=!1);a.version=++a.version;hookpunch.history[b].changes.splice(0,0,{propertyName:c.propertyName,value:a(),version:a.version})}})};return hookpunch.history}();
hookpunch=function(){var a={states:{NEW:1,CHANGED:2,UNCHANGED:3},options:null,initialised:!1,init:function(c){a.initialised||(a.options=$.extend({parentLink:!0,trackState:!0,history:!1},a.options,c),a.parentLink&&a.parentLink.init(),a.trackState&&a.trackState.init(),a.history&&a.history.init(),a.initialised=!0)},observable:function(c){var b=this;b.getUniqueId=function(){a.lastId||(a.lastId=0);return++a.lastId};b.init=function(c){ko.mapping.fromJS(c,{},b);b._hookpunch={};b._hookpunch.id=b.getUniqueId();
b._hookpunch.undoCalled=!1;a.history[b._hookpunch.id]={originalObject:c,changes:[]};for(prop in b)null!=b[prop]&&(void 0!=b[prop].extend&&prop!=a.options.stateField)&&(a.options.parentLink&&b[prop].extend({parentLink:{parent:b}}),a.options.trackState&&b[prop].extend({trackState:{originalValue:b[prop]()}}),a.options.history&&b[prop].extend({trackHistory:{propertyName:prop,hookpunchId:b._hookpunch.id}}))};b.undo=function(){var c=a.history[b._hookpunch.id].changes,d=c.splice(0,1)[0];if(d){a.history.undoFlag=
!0;a.history.busyRevertingValue=!0;var f=!1;for(index in c){var e=c[index];if(e.propertyName===d.propertyName&&e.version!==d.version){f=!0;b[d.propertyName].version=e.version;b[d.propertyName](e.value);break}}f||(b[d.propertyName].version=0,b[d.propertyName](b[d.propertyName].originalValue));a.history.busyRevertingValue=!1}};b.stateName=function(){for(state in a.states)if(a.states[state]===this[a.options.stateField])return state};b.init(c,!0);return b}};return a}();
hookpunch.parentLink=function(){hookpunch.parentLink={};hookpunch.parentLink.init=function(){hookpunch.initialised||(ko.extenders.parentLink=function(a,c){a.parent=c.parent})};return hookpunch.parentLink}();
hookpunch.trackState=function(){hookpunch.trackState={};hookpunch.trackState.init=function(){ko.extenders.trackState=function(a,c){a.originalValue=c.originalValue;a.originalState=a.parent[hookpunch.options.stateField]();if(void 0===a.parent[hookpunch.options.stateField])throw"Make sure you've initialised the correct stateField in hookpunch.init({ stateField: '[Your field name here]'});";a.subscribe(function(b){a.originalValue!==b?(a.originalState==hookpunch.states.NEW?a.parent[hookpunch.options.stateField]=
hookpunch.states.NEW:a.originalState==hookpunch.states.UNCHANGED&&(a.parent[hookpunch.options.stateField]=hookpunch.states.CHANGED),a.parent.change&&a.parent.change(a.parent),hookpunch.options.globalChange&&hookpunch.options.globalChange(a.parent)):(a.originalState==hookpunch.states.NEW?a.parent[hookpunch.options.stateField]=hookpunch.states.NEW:a.originalState==hookpunch.states.UNCHANGED&&(a.parent[hookpunch.options.stateField]=hookpunch.states.UNCHANGED),a.parent.revert&&a.parent.revert(a.parent),
hookpunch.options.globalRevert&&hookpunch.options.globalRevert(a.parent))});return a}};return hookpunch.trackState}();
